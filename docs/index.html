<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subspecies Mapper</title>
    <style>
        .container {
            text-align: left;
            margin: 20px;
        }
        iframe {
            width: 100%;
            height: 70vh;
            margin-top: 20px;
            border: 1px solid #ccc;
        }
        .dropdown {
            position: relative;
            display: inline-block;
            width: 300px;
        }
        .dropdown input {
            width: 100%;
            box-sizing: border-box;
        }
        .dropdown-menu {
            position: absolute;
            left: 0;
            top: 100%;
            width: 100%;
            border: 1px solid #ccc;
            background: #fff;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-menu div {
            padding: 8px;
            cursor: pointer;
            text-align: left;
        }
        .dropdown-menu div:hover {
            background-color: #f0f0f0;
        }
        .scientific-name {
            font-style: italic;
            color: #666;
        }
        .option-item {
            display: flex;
            justify-content: space-between;
        }
        .resolutions {
            margin-top: 20px;
        }
        .resolutions label {
            margin-right: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Subspecies Mapper</h1>
        <div><b>Species:</b></div>
        <div class="dropdown">
            <input type="text" id="speciesInput" placeholder="Start typing..." oninput="filterDropdown()" autocomplete="off">
            <div id="dropdownMenu" class="dropdown-menu"></div>
        </div>

        <div class="resolutions">
            <div><b>Resolution:</b></div>
            <label><input type="radio" name="resolution" value="2" onchange="updateResolution()"> Low</label>
            <label><input type="radio" name="resolution" value="3" checked="checked" onchange="updateResolution()"> Medium</label>
            <label><input type="radio" name="resolution" value="4" onchange="updateResolution()"> High</label>
            <label><input type="radio" name="resolution" value="5" onchange="updateResolution()"> Ultra</label>
        </div>

        <iframe id="mapFrame" src="" frameborder="0"></iframe>
    </div>

    <script>
        let speciesData = [];
        let selectedSpecies = null; //no selected species
        let selectedResolution = null; //no selected resolution

        // Load species data from CSV
        async function loadSpeciesData() {
            const response = await fetch('data/map_data.csv'); // Make sure species_data.csv is in the same directory
            const csvText = await response.text();
            speciesData = parseCSV(csvText);
            populateDropdown();
        }

        // Parse CSV into a usable array
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, i) => {
                    obj[header.trim()] = values[i].trim();
                    return obj;
                }, {});
            });
        }

        // Populate dropdown dynamically
        function populateDropdown() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.innerHTML = ''; // Clear previous options
            const uniqueSpecies = [...new Set(speciesData.map(({ common_name }) => common_name))];

            uniqueSpecies.forEach(commonName => {
                const species = speciesData.find(s => s.common_name === commonName);
                const option = document.createElement('div');
                option.classList.add('option-item');
                option.innerHTML = `
                    <span>${species.common_name}</span>
                    <span class="scientific-name">(${species.scientific_name})</span>
                `;
                option.dataset.value = species.common_name;
                option.dataset.scientificName = species.scientific_name; // Add scientific name for filtering
                option.onclick = () => selectSpecies(commonName);
                dropdownMenu.appendChild(option);
            });
        }

        // Filter dropdown based on input
        function filterDropdown() {
            const query = document.getElementById('speciesInput').value.toLowerCase();
            const dropdownMenu = document.getElementById('dropdownMenu');
            const options = dropdownMenu.children;

            let hasVisibleOptions = false;
            for (const option of options) {
                const species = option.dataset.value.toLowerCase();
                const scientificName = option.dataset.scientificName.toLowerCase();
                if (species.includes(query) || scientificName.includes(query)) {
                    option.style.display = 'block';
                    hasVisibleOptions = true;
                } else {
                    option.style.display = 'none';
                }
            }

            dropdownMenu.classList.toggle('show', hasVisibleOptions);
        }

        // Select a species
        function selectSpecies(commonName) {
            selectedSpecies = commonName;
            document.getElementById('speciesInput').value = commonName;
            document.getElementById('dropdownMenu').classList.remove('show');
            updateMap();
        }

        // Update resolution
        function updateResolution() {
            const resolutionRadios = document.querySelectorAll('input[name="resolution"]');
            selectedResolution = Array.from(resolutionRadios).find(radio => radio.checked).value;
            updateMap();
        }

        // Update the map based on selected species and resolution
        function updateMap() {
            if (!selectedSpecies || !selectedResolution) return;
            const mapData = speciesData.find(
                s => s.common_name === selectedSpecies && s.resolution === selectedResolution
            );
            const iframe = document.getElementById('mapFrame');
            iframe.src = mapData ? mapData.map_url : '';
        }

        // Initialize
        //loadSpeciesData();

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdownMenu = document.getElementById('dropdownMenu');
            const speciesInput = document.getElementById('speciesInput');
            if (!dropdownMenu.contains(e.target) && e.target !== speciesInput) {
                dropdownMenu.classList.remove('show');
            }
        });

        // Initialize
        async function initializePage() {
            await loadSpeciesData(); // Load species data from the CSV

            // Set default species and resolution
            selectedSpecies = "Red-tailed Hawk"; // Default species
            selectedResolution = "3"; // Default resolution

            // Pre-fill the input field
            document.getElementById('speciesInput').value = selectedSpecies;

            // Select the Low resolution radio button
            document.querySelector('input[name="resolution"][value="3"]').checked = true;

            // Show the default map
            updateMap();
        };

        // Call the initialization function after the DOM is ready
        initializePage();
    </script>
</body>
</html>
